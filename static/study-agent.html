<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Agent - Bible in a Year</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .study-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      .plan-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #4a90e2;
      }
      body.dark-mode .plan-card {
        background: #374151;
        border-color: #4b5563;
        border-left-color: #60a5fa;
      }
      .session-item {
        padding: 10px;
        margin: 8px 0;
        background: #f9f9f9;
        border-radius: 4px;
        border-left: 3px solid #4a90e2;
      }
      body.dark-mode .session-item {
        background: #2d2d2d;
        border-left-color: #60a5fa;
      }
      .quiz-question {
        background: #f0f7ff;
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
      }
      body.dark-mode .quiz-question {
        background: #1e3a5f;
      }
      .quiz-options {
        margin: 10px 0;
      }
      .quiz-option {
        padding: 8px;
        margin: 5px 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
      }
      body.dark-mode .quiz-option {
        background: #374151;
        border-color: #4b5563;
      }
      .quiz-option:hover {
        background: #e3f2fd;
      }
      body.dark-mode .quiz-option:hover {
        background: #2d2d2d;
      }
      .progress-bar {
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin: 10px 0;
      }
      body.dark-mode .progress-bar {
        background: #4b5563;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #60a5fa);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>Autonomous Study Agent</h1>
          <p>AI tutor for personalized Bible study</p>
        </div>
        <button id="toggle-theme" class="btn" title="Toggle dark mode" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">üåô</button>
      </div>
    </header>

    <main class="container">
      <div class="study-container">
        <a href="index.html" class="back-link">‚Üê Back to Daily Reading</a>
        
        <section class="card">
          <h2>Create Study Plan</h2>
          <div class="row">
            <input type="text" id="goal-input" placeholder="Describe your learning goal..." style="flex: 1; padding: 10px;" />
            <select id="level-select" style="width: 150px; padding: 10px;">
              <option value="beginner">Beginner</option>
              <option value="intermediate" selected>Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
            <button id="create-plan-btn" class="btn">Create Plan</button>
          </div>
        </section>

        <div id="plan-section" style="display: none;">
          <section class="card">
            <h2>Your Study Plan</h2>
            <div id="plan-info"></div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
            </div>
          </section>

          <section class="card">
            <h2>Study Sessions</h2>
            <div id="sessions-list"></div>
          </section>

          <section class="card" id="quiz-section" style="display: none;">
            <h2>Quiz: <span id="quiz-passage"></span></h2>
            <div id="quiz-questions"></div>
            <button id="submit-quiz-btn" class="btn" style="margin-top: 20px;">Submit Answers</button>
            <div id="quiz-result" style="display: none; margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;"></div>
          </section>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      <p>Autonomous Study Agent - Personalized learning at your pace</p>
    </footer>

    <script>
      const apiBase = "/api";
      let currentPlan = null;
      let currentQuiz = null;

      document.getElementById("create-plan-btn").addEventListener("click", createPlan);

      async function createPlan() {
        const goal = document.getElementById("goal-input").value.trim();
        const level = document.getElementById("level-select").value;

        if (!goal) {
          alert("Please enter a learning goal");
          return;
        }

        try {
          const response = await fetch(`${apiBase}/study-agent/create-plan`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              goal_description: goal,
              user_level: level
            })
          });

          if (!response.ok) {
            throw new Error("Failed to create study plan");
          }

          const data = await response.json();
          currentPlan = data;

          document.getElementById("plan-section").style.display = "block";
          displayPlan(data);

          // Load active plan to get sessions
          loadActivePlan();
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }

      async function loadActivePlan() {
        try {
          const response = await fetch(`${apiBase}/study-agent/active-plan`);
          if (!response.ok) {
            return;
          }

          const plan = await response.json();
          currentPlan = plan;
          displayPlan(plan);

          // Show current session quiz if available
          if (plan.current_session) {
            loadQuiz(plan.current_session.passage);
          }
        } catch (error) {
          // No active plan
        }
      }

      function displayPlan(plan) {
        const planInfo = document.getElementById("plan-info");
        planInfo.innerHTML = `
          <p><strong>Goal:</strong> ${plan.goal.description}</p>
          <p><strong>Passages:</strong> ${plan.goal.target_passages.join(", ")}</p>
          <p><strong>Estimated Days:</strong> ${plan.goal.estimated_days}</p>
        `;

        const progress = plan.overall_progress || 0;
        document.getElementById("progress-fill").style.width = `${progress * 100}%`;
        document.getElementById("progress-fill").textContent = `${(progress * 100).toFixed(0)}%`;

        if (plan.sessions) {
          const sessionsList = document.getElementById("sessions-list");
          sessionsList.innerHTML = plan.sessions.map((session, index) => `
            <div class="session-item">
              <strong>Session ${index + 1}:</strong> ${session.passage}
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Date: ${session.date} | 
                Score: ${(session.understanding_score * 100).toFixed(0)}%
                ${session.passage === plan.current_session?.passage ? " (Current)" : ""}
              </div>
              ${session.passage === plan.current_session?.passage && session.understanding_score === 0 ?
                `<button class="btn" onclick="loadQuiz('${session.passage}')" style="margin-top: 10px; font-size: 12px;">Take Quiz</button>` : ""}
            </div>
          `).join("");
        }
      }

      async function loadQuiz(passage) {
        try {
          const response = await fetch(`${apiBase}/study-agent/quiz/${encodeURIComponent(passage)}?difficulty=intermediate`);
          if (!response.ok) {
            throw new Error("Failed to load quiz");
          }

          const data = await response.json();
          currentQuiz = data;

          document.getElementById("quiz-section").style.display = "block";
          document.getElementById("quiz-passage").textContent = passage;

          const quizQuestions = document.getElementById("quiz-questions");
          quizQuestions.innerHTML = data.questions.map((q, index) => `
            <div class="quiz-question">
              <div style="font-weight: 600; margin-bottom: 10px;">${index + 1}. ${q.question}</div>
              ${q.type === "multiple_choice" && q.options ?
                `<div class="quiz-options">
                  ${q.options.map((opt, optIndex) => `
                    <label class="quiz-option">
                      <input type="radio" name="q${index}" value="${String.fromCharCode(65 + optIndex)}" />
                      ${String.fromCharCode(65 + optIndex)}. ${opt}
                    </label>
                  `).join("")}
                </div>` :
                `<textarea name="q${index}" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Your answer..."></textarea>`
              }
            </div>
          `).join("");
        } catch (error) {
          alert(`Error loading quiz: ${error.message}`);
        }
      }

      window.loadQuiz = loadQuiz; // Make accessible globally

      document.getElementById("submit-quiz-btn").addEventListener("click", submitQuiz);

      async function submitQuiz() {
        if (!currentQuiz) return;

        const form = document.getElementById("quiz-questions");
        const answers = {};
        const questions = currentQuiz.questions;

        questions.forEach((q, index) => {
          const input = form.querySelector(`[name="q${index}"]:checked`) || form.querySelector(`[name="q${index}"]`);
          if (input) {
            answers[index] = input.value || input.textContent || "";
          }
        });

        try {
          const response = await fetch(`${apiBase}/study-agent/assess`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              passage: currentQuiz.passage,
              answers: answers,
              questions: questions
            })
          });

          if (!response.ok) {
            throw new Error("Failed to submit quiz");
          }

          const result = await response.json();
          
          document.getElementById("quiz-result").style.display = "block";
          document.getElementById("quiz-result").innerHTML = `
            <h3>Quiz Result</h3>
            <p><strong>Understanding Score:</strong> ${(result.understanding_score * 100).toFixed(0)}%</p>
            <p><strong>Feedback:</strong> ${result.feedback}</p>
          `;

          // Reload plan to show updated progress
          loadActivePlan();
        } catch (error) {
          alert(`Error submitting quiz: ${error.message}`);
        }
      }

      // Dark mode toggle
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDark);
      }

      document.getElementById("toggle-theme").addEventListener("click", toggleDarkMode);

      if (localStorage.getItem("darkMode") === "true") {
        toggleDarkMode();
      }

      // Load active plan on page load
      loadActivePlan();
    </script>
  </body>
</html>
