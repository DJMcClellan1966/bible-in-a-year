<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bible Discovery - Deep Exploration Mode</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .discover-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .passage-input-area {
        background: #f0f7ff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      body.dark-mode .passage-input-area {
        background: #1e3a5f;
      }
      .discovery-tabs {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }
      .discovery-tab {
        padding: 10px 20px;
        background: white;
        border: 2px solid #4a90e2;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }
      body.dark-mode .discovery-tab {
        background: #374151;
        color: #f9fafb;
        border-color: #60a5fa;
      }
      .discovery-tab:hover {
        background: #e3f2fd;
      }
      body.dark-mode .discovery-tab:hover {
        background: #2d2d2d;
      }
      .discovery-tab.active {
        background: #4a90e2;
        color: white;
      }
      body.dark-mode .discovery-tab.active {
        background: #60a5fa;
        color: #1e3a8a;
      }
      .discovery-section {
        display: none;
        margin-top: 20px;
      }
      .discovery-section.active {
        display: block;
      }
      .insight-card {
        background: #fff9e6;
        padding: 20px;
        margin: 15px 0;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
      }
      body.dark-mode .insight-card {
        background: #3d3420;
        border-left-color: #fbbf24;
      }
      .commentary-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .commentary-perspective {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid #4a90e2;
      }
      body.dark-mode .commentary-perspective {
        background: #2d2d2d;
        border-left-color: #60a5fa;
      }
      .context-box {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      body.dark-mode .context-box {
        background: #1b3d1f;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>Bible Discovery Mode</h1>
          <p>Deep exploration - Find meaning you'd never find on your own</p>
        </div>
        <button id="toggle-theme" class="btn" title="Toggle dark mode" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">üåô</button>
      </div>
    </header>

    <main class="container">
      <div class="discover-container">
        <a href="index.html" class="back-link">‚Üê Back to Traditional Reading</a>
        
        <div class="passage-input-area">
          <h2>What passage would you like to explore?</h2>
          <p style="margin: 10px 0; color: #666;">Enter any Bible reference (e.g., "Genesis 1", "Psalm 23", "John 3:16")</p>
          <div class="row">
            <input type="text" id="passage-input" placeholder="e.g., Genesis 1:1-5 or Romans 8" style="flex: 1; padding: 12px; font-size: 16px;" />
            <select id="discover-version" style="width: 150px; padding: 12px;"></select>
            <button id="discover-btn" class="btn" style="padding: 12px 24px; font-size: 16px;">Discover Deeply</button>
          </div>
          
          <div style="margin-top: 15px;">
            <strong>Quick picks:</strong>
            <button class="discovery-tab" onclick="loadPassage('Genesis 1')" style="margin: 5px;">Genesis 1</button>
            <button class="discovery-tab" onclick="loadPassage('Psalm 23')" style="margin: 5px;">Psalm 23</button>
            <button class="discovery-tab" onclick="loadPassage('John 3:16-21')" style="margin: 5px;">John 3:16</button>
            <button class="discovery-tab" onclick="loadPassage('Romans 8')" style="margin: 5px;">Romans 8</button>
            <button class="discovery-tab" onclick="loadPassage('1 Corinthians 13')" style="margin: 5px;">1 Cor 13</button>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: rgba(74,144,226,0.1); border-radius: 8px;">
            <strong style="display: block; margin-bottom: 10px;">üéØ Thematic Discovery Paths (No pressure - explore at your pace):</strong>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <button class="discovery-tab" onclick="startThematicPath('faith')" style="background: #fff; border-color: #28a745;">The Journey of Faith</button>
              <button class="discovery-tab" onclick="startThematicPath('prophecy')" style="background: #fff; border-color: #ff9800;">Prophecy & Fulfillment</button>
              <button class="discovery-tab" onclick="startThematicPath('parables')" style="background: #fff; border-color: #9c27b0;">The Parables Explained</button>
              <button class="discovery-tab" onclick="startThematicPath('psalms')" style="background: #fff; border-color: #00bcd4;">Psalms for Today</button>
              <button class="discovery-tab" onclick="startThematicPath('paul')" style="background: #fff; border-color: #f44336;">Paul's Theology</button>
            </div>
            <div id="thematic-path-info" style="margin-top: 10px; font-size: 0.9em; color: #666; display: none;"></div>
          </div>
        </div>

        <div id="discovery-loading" style="display: none; text-align: center; padding: 40px;">
          <p>Exploring deeply... Gathering insights from Augustine, Aquinas, and scholars...</p>
        </div>

        <div id="discovery-results" style="display: none;">
          <!-- Passage Text -->
          <section class="card">
            <h2 id="result-passage-title"></h2>
            <div id="result-passage-text" class="content"></div>
          </section>

          <!-- Deep Insights Tabs -->
          <div class="discovery-tabs">
            <button class="discovery-tab active" data-tab="commentaries">Multiple Perspectives</button>
            <button class="discovery-tab" data-tab="context">Historical Context</button>
            <button class="discovery-tab" data-tab="connections">Connections & Echoes</button>
            <button class="discovery-tab" data-tab="insights">Hidden Meanings</button>
          </div>

          <!-- Commentaries Section -->
          <div id="tab-commentaries" class="discovery-section active">
            <section class="card">
              <h2>Commentary Perspectives</h2>
              <p>Multiple views from church fathers and scholars synthesized together</p>
              <div id="commentaries-content"></div>
            </section>
          </div>

          <!-- Context Section -->
          <div id="tab-context" class="discovery-section">
            <section class="card">
              <h2>Historical & Cultural Context</h2>
              <div id="context-content"></div>
            </section>
          </div>

          <!-- Connections Section -->
          <div id="tab-connections" class="discovery-section">
            <section class="card">
              <h2>Scriptural Connections</h2>
              <div id="connections-content"></div>
            </section>
          </div>

          <!-- Insights Section -->
          <div id="tab-insights" class="discovery-section">
            <section class="card">
              <h2>Hidden Meanings & Insights</h2>
              <div id="insights-content"></div>
            </section>
          </div>

          <!-- Notes Section -->
          <section class="card" style="margin-top: 30px;">
            <h2>Your Discoveries & Notes</h2>
            <textarea id="discovery-notes" rows="6" placeholder="Capture insights, questions, connections you're discovering..." style="width: 100%; padding: 10px;"></textarea>
            <button id="save-discovery" class="btn" style="margin-top: 10px;">Save Insights</button>
          </section>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      <p>Discovery Mode - No pressure, just deep exploration</p>
    </footer>

    <script>
      const apiBase = "/api";
      let currentPassage = null;

      // Tab switching
      document.querySelectorAll(".discovery-tab[data-tab]").forEach(tab => {
        tab.addEventListener("click", () => {
          const tabName = tab.dataset.tab;
          document.querySelectorAll(".discovery-tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          document.querySelectorAll(".discovery-section").forEach(s => s.classList.remove("active"));
          document.getElementById(`tab-${tabName}`).classList.add("active");
        });
      });

      // Load versions
      async function loadVersions() {
        const response = await fetch(`${apiBase}/bible/versions`);
        if (!response.ok) return;
        const data = await response.json();
        const select = document.getElementById("discover-version");
        data.versions.forEach(v => {
          const option = document.createElement("option");
          option.value = v.id;
          option.textContent = `${v.id} - ${v.title}`;
          select.appendChild(option);
        });
        if (data.default_version) {
          select.value = data.default_version;
        }
      }

      const thematicPaths = {
        faith: {
          name: "The Journey of Faith",
          description: "Key passages exploring faith, trust, and relationship with God",
          passages: ["Genesis 15:6", "Hebrews 11:1", "Romans 4", "James 2:14-26", "Ephesians 2:8-10"],
          currentIndex: 0
        },
        prophecy: {
          name: "Prophecy & Fulfillment",
          description: "How Old Testament prophecies find fulfillment in the New Testament",
          passages: ["Isaiah 7:14", "Matthew 1:22-23", "Isaiah 53", "Matthew 8:17", "Micah 5:2", "Matthew 2:5-6"],
          currentIndex: 0
        },
        parables: {
          name: "The Parables Explained",
          description: "Deep dives into Jesus' parables with scholarly commentary",
          passages: ["Matthew 13:1-23", "Luke 15:11-32", "Matthew 25:14-30", "Mark 4:26-29", "Luke 10:25-37"],
          currentIndex: 0
        },
        psalms: {
          name: "Psalms for Today",
          description: "Exploring the emotional and spiritual depth of the Psalms",
          passages: ["Psalm 23", "Psalm 51", "Psalm 139", "Psalm 1", "Psalm 46"],
          currentIndex: 0
        },
        paul: {
          name: "Paul's Theology",
          description: "Major theological themes in Paul's letters",
          passages: ["Romans 8", "1 Corinthians 13", "Galatians 5:16-26", "Ephesians 1:3-14", "Philippians 2:5-11"],
          currentIndex: 0
        }
      };

      window.currentThematicPath = null;

      window.startThematicPath = function(pathId) {
        const path = thematicPaths[pathId];
        if (!path) return;
        
        window.currentThematicPath = {id: pathId, ...path};
        path.currentIndex = 0;
        
        document.getElementById("thematic-path-info").style.display = "block";
        document.getElementById("thematic-path-info").innerHTML = `
          <strong>${path.name}</strong> - ${path.description}<br>
          <span style="color: #4a90e2;">Passage ${path.currentIndex + 1} of ${path.passages.length}</span>
          <button onclick="nextThematicPassage()" style="margin-left: 10px; padding: 4px 12px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">Next ‚Üí</button>
        `;
        
        loadPassage(path.passages[0]);
      };

      window.nextThematicPassage = function() {
        if (!window.currentThematicPath) return;
        
        const path = thematicPaths[window.currentThematicPath.id];
        path.currentIndex++;
        
        if (path.currentIndex >= path.passages.length) {
          document.getElementById("thematic-path-info").innerHTML = `
            <strong>üéâ Completed: ${path.name}</strong><br>
            <span style="color: #28a745;">You've explored all ${path.passages.length} passages in this thematic path!</span>
            <button onclick="startThematicPath('${window.currentThematicPath.id}')" style="margin-left: 10px; padding: 4px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Start Over</button>
          `;
          window.currentThematicPath = null;
          return;
        }
        
        document.getElementById("thematic-path-info").innerHTML = `
          <strong>${path.name}</strong> - ${path.description}<br>
          <span style="color: #4a90e2;">Passage ${path.currentIndex + 1} of ${path.passages.length}</span>
          <button onclick="nextThematicPassage()" style="margin-left: 10px; padding: 4px 12px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">Next ‚Üí</button>
        `;
        
        loadPassage(path.passages[path.currentIndex]);
      };

      window.loadPassage = async function(passage) {
        document.getElementById("passage-input").value = passage;
        await discoverPassage();
      };

      document.getElementById("discover-btn").addEventListener("click", discoverPassage);
      document.getElementById("passage-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") discoverPassage();
      });

      async function discoverPassage() {
        const passage = document.getElementById("passage-input").value.trim();
        if (!passage) {
          alert("Please enter a passage reference");
          return;
        }

        currentPassage = passage;
        const version = document.getElementById("discover-version").value;
        
        document.getElementById("discovery-loading").style.display = "block";
        document.getElementById("discovery-results").style.display = "none";
        document.getElementById("discovery-loading").innerHTML = "<p>Exploring deeply... Gathering insights from Augustine, Aquinas, historians, and scholars...</p>";

        try {
          // Use the comprehensive discovery endpoint
          const response = await fetch(`${apiBase}/discover/${encodeURIComponent(passage)}?version=${version || ''}`);
          if (!response.ok) {
            throw new Error(`Discovery failed: ${response.statusText}`);
          }
          const data = await response.json();

          // Display comprehensive results
          displayDiscoveryResults(data);

        } catch (error) {
          document.getElementById("discovery-loading").innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
      }

      function displayDiscoveryResults(data) {
        document.getElementById("discovery-loading").style.display = "none";
        document.getElementById("discovery-results").style.display = "block";

        const passage = data.passage;
        
        // Passage title and text
        document.getElementById("result-passage-title").textContent = passage;
        
        const passageText = data.passage_text;
        if (passageText && passageText.verses) {
          const versesHtml = Object.entries(passageText.verses)
            .map(([v, text]) => `<div style="margin: 8px 0; padding: 8px; background: rgba(74,144,226,0.05); border-left: 3px solid #4a90e2;"><strong>${v}</strong> ${text}</div>`)
            .join("");
          document.getElementById("result-passage-text").innerHTML = versesHtml;
        } else {
          document.getElementById("result-passage-text").textContent = "Passage text not available";
        }

        // Commentaries
        const commentariesDiv = document.getElementById("commentaries-content");
        commentariesDiv.innerHTML = "";
        const commentaries = data.commentaries || {};
        
        if (commentaries.augustine) {
          commentariesDiv.innerHTML += `
            <div class="commentary-perspective">
              <h3>Augustine's Perspective</h3>
              <pre style="white-space: pre-wrap; font-family: inherit; max-height: 500px; overflow-y: auto;">${commentaries.augustine}</pre>
            </div>
          `;
        }

        if (commentaries.aquinas) {
          commentariesDiv.innerHTML += `
            <div class="commentary-perspective">
              <h3>Aquinas's Analysis</h3>
              <pre style="white-space: pre-wrap; font-family: inherit; max-height: 500px; overflow-y: auto;">${commentaries.aquinas}</pre>
            </div>
          `;
        }

        if (commentaries.combined) {
          commentariesDiv.innerHTML += `
            <div class="commentary-perspective" style="grid-column: 1 / -1; border-left-color: #28a745;">
              <h3>Synthesized Perspective</h3>
              <pre style="white-space: pre-wrap; font-family: inherit;">${commentaries.combined}</pre>
            </div>
          `;
        }

        if (commentariesDiv.innerHTML === "") {
          commentariesDiv.innerHTML = "<p>Commentaries are being generated. This may take a minute...</p>";
        }

        // Context - Timeline Events
        const timelineEvents = data.timeline_events || [];
        let contextHtml = "";
        
        if (timelineEvents.length > 0) {
          contextHtml += '<div class="context-box"><h3>Historical Events</h3>';
          timelineEvents.forEach(event => {
            contextHtml += `
              <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                <strong>${event.title || event.event_id}</strong>
                ${event.date_estimate ? `<br><em>Date: ${event.date_estimate}</em>` : ''}
                ${event.description ? `<p>${event.description}</p>` : ''}
              </div>
            `;
          });
          contextHtml += '</div>';
        } else {
          contextHtml += '<div class="context-box"><p><em>Historical context is being analyzed...</em></p></div>';
        }

        // Characters
        const characters = data.characters || [];
        if (characters.length > 0) {
          contextHtml += '<div class="context-box" style="margin-top: 15px;"><h3>Key Characters</h3>';
          characters.forEach(char => {
            contextHtml += `
              <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                <strong>${char.name}</strong> <span style="color: #666; font-size: 0.9em;">(${char.category})</span>
                ${char.description ? `<p style="margin-top: 5px;">${char.description}</p>` : ''}
              </div>
            `;
          });
          contextHtml += '</div>';
        }

        document.getElementById("context-content").innerHTML = contextHtml;

        // Connections
        const insights = data.insights || {};
        const connections = insights.connections || [];
        let connectionsHtml = "";
        
        if (connections.length > 0) {
          connectionsHtml += '<div class="insight-card"><h3>Scriptural Connections</h3>';
          connections.forEach(conn => {
            connectionsHtml += `
              <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.7); border-left: 3px solid #ffc107;">
                <strong>${conn.related_passage}</strong>
                <span style="color: #666; font-size: 0.9em;">(${conn.relationship})</span>
                ${conn.explanation ? `<p style="margin-top: 5px;">${conn.explanation}</p>` : ''}
              </div>
            `;
          });
          connectionsHtml += '</div>';
        }

        // Narrative connection
        const narrative = data.narrative || {};
        if (narrative.story_id) {
          connectionsHtml += `
            <div class="insight-card" style="background: #e8f5e9; border-left-color: #28a745;">
              <h3>Part of Story: ${narrative.title || narrative.story_id}</h3>
              ${narrative.description ? `<p>${narrative.description}</p>` : ''}
              ${narrative.passages ? `<p><strong>Related passages:</strong> ${narrative.passages.join(', ')}</p>` : ''}
            </div>
          `;
        }

        if (connectionsHtml === "") {
          connectionsHtml = '<div class="insight-card"><p><em>Analyzing scriptural connections...</em></p></div>';
        }

        document.getElementById("connections-content").innerHTML = connectionsHtml;

        // Hidden meanings / Insights
        const predictedQuestions = insights.questions || [];
        const warnings = insights.warnings || [];
        let insightsHtml = "";
        
        if (predictedQuestions.length > 0) {
          insightsHtml += '<div class="insight-card"><h3>Questions to Consider</h3><ul>';
          predictedQuestions.forEach(q => {
            insightsHtml += `<li>${q}</li>`;
          });
          insightsHtml += '</ul></div>';
        }

        if (warnings.length > 0) {
          insightsHtml += '<div class="insight-card" style="background: #fff3cd; border-left-color: #ff9800;"><h3>‚ö†Ô∏è Note</h3><ul>';
          warnings.forEach(w => {
            insightsHtml += `<li>${w}</li>`;
          });
          insightsHtml += '</ul></div>';
        }

        if (commentaries.combined) {
          insightsHtml += `
            <div class="insight-card">
              <h3>Deep Insights</h3>
              <p>The synthesized commentary above brings together multiple perspectives to reveal meanings you might not discover on your own. Compare Augustine's spiritual depth with Aquinas's systematic analysis to see how different theological traditions illuminate different aspects of the text.</p>
            </div>
          `;
        }

        if (insightsHtml === "") {
          insightsHtml = '<div class="insight-card"><p><em>Analyzing for hidden meanings and insights...</em></p></div>';
        }

        document.getElementById("insights-content").innerHTML = insightsHtml;
      }

      // Dark mode
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
      }

      document.getElementById("toggle-theme").addEventListener("click", toggleDarkMode);
      if (localStorage.getItem("darkMode") === "true") {
        toggleDarkMode();
      }

      // Load versions on page load
      loadVersions();
    </script>
  </body>
</html>
